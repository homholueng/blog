---
title: PEP 302 - New Import Hooks
categories: 
- Python Daily
tags:
- Python
---

## Abstract

该提议为了使得开发者能够对 Python 的模块导入机制进行更好的自定义，提出了一种新的导入钩子，这种新型的机制能够更好注入到现有的导入机制中，并且对模块的查找和导入提供了更细粒度的控制。

## Motivation

在该提议出现之前，如果开发者要自定义模块的导入机制，需要重载内置的 `__import__` 函数，但是重载该函数十分麻烦，需要完全实现整个 `import` 的机制，还需要处理各种复杂的情况。

## Use Case

该提议提出的方案用于加载一些与一般模块存储方式不同的模块，例如打包好的模块，pyc 文件，从网络或数据库中读取的模块等等。

## Rationale

该提议提出的钩子机制设计如下：在 `sys` 模块中添加一个新的 `path_hooks` 列表，该列表中的对象会被遍历以检测其是否能够处理 `sys.path` 中的某一条记录，直到找到能够处理的对象为止。但是每进行一次导入操作就遍历一次 `sys.path_hooks` 的话对性能会有一定的影响，所以遍历 `sys.path_hooks` 的结果会被缓存到 `sys.path_importer_cache` 中，该缓存是 `sys.path` 中的记录到 `path_hooks` 返回的模块导入器的映射。

为了最小化对 `import.c` 的影响以及避免增加额外的性能开销。该方案默认不会为现有的文件系统导入逻辑添加显式的钩子和导入器对象，如果 `sys.path_hooks` 中没有任何一个对象能够处理 `sys.path` 中的记录的话，就会回归到内置的导入逻辑。同时，这条记录在 `sys.path_importer_cache` 中映射会被置为 `None`，避免再次进行 `sys.path_hooks` 的遍历。

那么问题来了：对于那些不需要处理 `sys.path` 的自定义导入器应该如何处理呢？

为了解决这个问题，该提议还给出了另外一个新的机制：在 `sys` 模块中添加一个新的导入器列表 `meta_path`，这个列表中的导入器会在 `sys.path` 之前进行遍历并询问其是否能够处理即将要被导入的模块，该列表默认为空。

## Importer protocol